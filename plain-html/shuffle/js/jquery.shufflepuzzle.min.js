!function(t){t.fn.shufflepuzzle=function(i){var e={img_puzzle:"img/puzzle.jpg",width:400,height:400,showStart:!0,tilesH:4,tilesV:4,gap:!0,auto_size:!1,duration:200,bgColor:"#fff",bgOpacity:1,imgBgOpacity:.2,shuffleNum:5,menuVisible:!1,menuNameShuffle:"Shuffle",menuNameGrid:"Grid",menuNameImage:null,menu_shuffle:null,menu_grid:null,menu_image:null,onStart:null,onChange:null,afterCreate:null,onCompleted:function(){alert("Congratulations, you've won!")},firstStart:null,stop:!1},i=t.extend(e,i),a=Math.round(999999*Math.random()),o=!1;return this.each(function(){function e(i){u.showStart||(u.duration=1),i&&t("#imgbg"+a).attr("src",u.img_puzzle),s()}function n(){for(var i in u.menu_shuffle)x+="<li>"+i+"</li>";if(u.menu_grid)for(var o=0;o<u.menu_grid.length;o++)V+="<li>"+u.menu_grid[o]+"</li>";if(!u.control_image)for(var i in u.menu_image)C+="<li>"+i+"</li>";var n="",l="",r="";u.menuNameShuffle&&(n="<li>"+u.menuNameShuffle+'<ul class="pz_shuffle'+a+'">'+x+"</ul></li>"),u.menuNameGrid&&(l="<li>"+u.menuNameGrid+'<ul class="pz_grid'+a+'">'+V+"</ul></li>"),u.menuNameImage&&(r="<li>"+u.menuNameImage+'<ul class="pz_img'+a+'">'+C+"</ul></li>"),t(M).prepend('<div class="sp_bg visible" id="bg'+a+'"><img class="imgbg" id="imgbg'+a+'" width="'+u.width+'" height="'+u.height+'" src="'+u.img_puzzle+'" /></div>'),t("#imgbg"+a).css({transition:"opacity "+N+"ms ease-out"}),u.menuVisible&&t(M).prepend('<div class="spmenu" id="menu'+a+'"><ul id="puzzle-navigation">'+n+l+r+"</ul></div>"),t("ul.pz_shuffle"+a+" li").bind("mousedown touchstart",function(i){2!=i.button&&(t(".img_title"+a).remove(),u.shuffleNum=u.menu_shuffle[t(this).text()],e())}),t("ul.pz_grid"+a+" li").bind("mousedown touchstart",function(i){2!=i.button&&(t(".img_title"+a).remove(),g=t(this).text().replace(/[^A-Za-z0-9#:;-]/g,"").split("x"),u.tilesV=parseInt(g[0]),u.tilesH=parseInt(g[1]),d=u.tilesV*u.tilesH,e())}),t("ul.pz_img"+a+" li").bind("mousedown touchstart",function(i){if(2!=i.button&&u.img_puzzle!=u.menu_image[t(this).text()]){t(".img_title"+a).remove();var o=u.menu_image[t(this).text()];I.src=u.img_puzzle=o,I.onload=function(){e(1)}}}),t("#bg"+a).css({"background-color":u.bgColor,opacity:u.bgOpacity}).bind("mousedown touchstart",function(t){var i=t||event;i.preventDefault?i.preventDefault():i.returnValue=!1}),t(M).bind("mousedown touchstart",function(t){var i=t||event;i.preventDefault?i.preventDefault():i.returnValue=!1}),t("#menu"+a).css({color:"white",position:"absolute","z-index":9999}),y&&(u.firstStart(),y=!1),u.stop||s(),h(),t(window).resize(function(){h()})}function l(){t("#bg"+a).removeClass("visible").css({"background-color":u.bgColor,opacity:u.bgOpacity})}function s(){function i(){c=Math.round(Math.random()*(d-2));var i=t("#img_num"+c+a).data().name;for(w=!1;!w;)z!=i&&(i+1==_&&_%u.tilesH!=0||i-1==_&&_%u.tilesH!=u.tilesH-1?(b=i,z=_,t("#img_num"+c+a).data("name",_).css({left:s+_%u.tilesH*Math.floor(u.width/u.tilesH)+"px"}),e(),_=b,w=!0):(i+u.tilesH==_||i-u.tilesH==_)&&(b=i,z=_,t("#img_num"+c+a).data("name",_).css({top:g+Math.floor(_/u.tilesH)*Math.floor(u.height/u.tilesV)+"px"}),e(),_=b,w=!0)),c=Math.round(Math.random()*(d-2)),i=t("#img_num"+c+a).data().name;p++}function e(){p<u.shuffleNum-1?setTimeout(i,u.duration/5):(u.showStart||(t(".sh_puzzle > .anim").css({transition:"all "+N+"ms ease-out"}),t("#imgbg"+a).css({opacity:u.imgBgOpacity}),setTimeout(function(){u.duration=N,t(".sh_puzzle > .anim").css("opacity",1)},N)),u.afterCreate&&u.afterCreate(),u.showStart||l())}function n(){for(H=0;d-1>H;H++)if(t("#img_num"+H+a).data().etalon==t("#img_num"+H+a).data().name==0)return!1;return!0}for(w=!1,_=d-1,z=-1,b=_,o=!1,r=[],m=[],u.showStart&&(l(),t("#imgbg"+a).css({opacity:u.imgBgOpacity})),H=0;d>H;H++)r.push(H),m.push(H);p=0;var s=Math.floor((u.width-Math.floor(u.width/u.tilesH)*u.tilesH)/2),g=Math.floor((u.height-Math.floor(u.height/u.tilesV)*u.tilesV)/2);for(H=0;H<u.tilesV;H++)for(v=0;v<u.tilesH;v++)t(M).prepend('<div class="anim img_title'+a+'" id="img_num'+p+a+'"><img id="imgb'+p+a+'" width="'+u.width+'" height="'+u.height+'" src="'+u.img_puzzle+'"></div>'),t("#imgb"+p+a).css({"margin-top":"-"+(g+H*Math.floor(u.height/u.tilesV))+"px","margin-left":"-"+(s+v*Math.floor(u.width/u.tilesH))+"px","max-width":"none"}),t("#img_num"+p+a).css({width:Math.floor(u.width/u.tilesH)-f+"px",height:Math.floor(u.height/u.tilesV)-f+"px",position:"absolute",overflow:"hidden",left:s+v*Math.floor(u.width/u.tilesH)+"px",top:g+H*Math.floor(u.height/u.tilesV)+"px","z-index":1}).data({name:r[p],etalon:r[p]}).bind("mousedown touchstart",function(i){return o?!1:(2!=i.button&&(t(this).data().name+1==_&&_%u.tilesH!=0||t(this).data().name-1==_&&_%u.tilesH!=u.tilesH-1?(b=t(this).data().name,t(this).data("name",_).css({left:s+_%u.tilesH*Math.floor(u.width/u.tilesH)+"px"}),_=b,u.onChange&&u.onChange()):(t(this).data().name+u.tilesH==_||t(this).data().name-u.tilesH==_)&&(b=t(this).data().name,t(this).data("name",_).css({top:g+Math.floor(_/u.tilesH)*Math.floor(u.height/u.tilesV)+"px"}),_=b,u.onChange&&u.onChange()),n()&&(t("#imgbg"+a).css("opacity",1),t("#bg"+a).addClass("visible"),u.onCompleted&&(o=!0,setTimeout(function(){u.onCompleted()},u.duration+50)))),void 0)}),p++,p==d-1&&(v=u.tilesH);u.showStart?t(".sh_puzzle > .anim").css({transition:"all "+u.duration+"ms ease-out"}):t(".sh_puzzle > .anim").css({opacity:0}),_=r[r[d-1]];var c=0;return p=0,0==u.shuffleNum?!1:(setTimeout(i,100),h(),u.onStart&&u.onStart(),void 0)}function h(){u.auto_size&&(u.width=t(M).parent().width(),u.height=u.width/S),t(M).width(u.width).height(u.height),t("#loading"+a).width(u.width).height(u.height),t("#imgbg"+a).width(u.width).height(u.height);var i=Math.floor((u.width-Math.floor(u.width/u.tilesH)*u.tilesH)/2),e=Math.floor((u.height-Math.floor(u.height/u.tilesV)*u.tilesV)/2);for(c=0,H=0;H<u.tilesV;H++)for(v=0;v<u.tilesH;v++)t("#imgb"+c+a).css({width:u.width+"px",height:u.height+"px","margin-top":"-"+(e+H*Math.floor(u.height/u.tilesV))+"px","margin-left":"-"+(i+v*Math.floor(u.width/u.tilesH))+"px"}),t("#img_num"+c+a).css({width:Math.floor(u.width/u.tilesH)-f+"px",height:Math.floor(u.height/u.tilesV)-f+"px",left:i+t("#img_num"+c+a).data("name")%u.tilesH*Math.floor(u.width/u.tilesH)+"px",top:e+Math.floor(t("#img_num"+c+a).data("name")/u.tilesH)*Math.floor(u.height/u.tilesV)+"px"}),c++}t.fn.shufflepuzzle[t(this).attr("id")]=function(i){t(".img_title"+a).remove(),u=t.extend(u,i),e(1)};var u=i,r=[],m=[],g=[],d=u.tilesV*u.tilesH,f=u.gap?1:0,p=0,c=0,w=!1,_=d-1,z=-1,b=_,v=0,H=0,M=t(this),x="",V="",C="",S=1,y=u.firstStart,N=u.duration;t(M).width(u.width).height(u.height).addClass("sh_puzzle"),u.showStart||(u.duration=1),S=u.width/u.height;var I=new Image;I.onload=function(){n()},I.src=u.img_puzzle})}}(jQuery);