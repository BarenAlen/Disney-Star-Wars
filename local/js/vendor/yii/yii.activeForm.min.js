/*
 Copyright (c) 2008 Yii Software LLC
 @license http://www.yiiframework.com/license/
 @author Qiang Xue <qiang.xue@gmail.com>
 @since 2.0
*/
(function(e){e.fn.yiiActiveForm=function(a){return h[a]?h[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?(e.error("Method "+a+" does not exist on jQuery.yiiActiveForm"),!1):h.init.apply(this,arguments)};var y={encodeErrorSummary:!0,errorSummary:".error-summary",validateOnSubmit:!0,errorCssClass:"has-error",successCssClass:"has-success",validatingCssClass:"validating",ajaxParam:"ajax",ajaxDataType:"json",validationUrl:void 0,scrollToError:!0,scrollToErrorOffset:0},v=
{id:void 0,name:void 0,container:void 0,input:void 0,error:".help-block",encodeError:!0,validateOnChange:!0,validateOnBlur:!0,validateOnType:!1,validationDelay:500,enableAjaxValidation:!1,validate:void 0,status:0,cancelled:!1,value:void 0,updateAriaInvalid:!0},n,p=function(a){n&&(n.resolve(),n=void 0,a.removeData("yiiSubmitFinalizePromise"))},h={init:function(a,b){return this.each(function(){var c=e(this);if(!c.data("yiiActiveForm")){var d=e.extend({},y,b||{});void 0===d.validationUrl&&(d.validationUrl=
c.attr("action"));e.each(a,function(b){a[b]=e.extend({value:m(c,this)},v,this);w(c,a[b])});c.data("yiiActiveForm",{settings:d,attributes:a,submitting:!1,validated:!1,options:z(c)});c.bind("reset.yiiActiveForm",h.resetForm);d.validateOnSubmit&&(c.on("mouseup.yiiActiveForm keyup.yiiActiveForm",":submit",function(){c.data("yiiActiveForm").submitObject=e(this)}),c.on("submit.yiiActiveForm",h.submitForm));d=e.Event("afterInit");c.trigger(d)}})},add:function(a){var b=e(this);a=e.extend({value:m(b,a)},v,
a);b.data("yiiActiveForm").attributes.push(a);w(b,a)},remove:function(a){var b=e(this),c=b.data("yiiActiveForm").attributes,d=-1,f=void 0;e.each(c,function(b){if(c[b].id==a)return d=b,f=c[b],!1});0<=d&&(c.splice(d,1),q(b,f).off(".yiiActiveForm"));return f},validateAttribute:function(a){a=h.find.call(this,a);void 0!=a&&r(e(this),a,!0)},find:function(a){var b=e(this).data("yiiActiveForm").attributes,c=void 0;e.each(b,function(d){if(b[d].id==a)return c=b[d],!1});return c},destroy:function(){return this.each(function(){e(this).unbind(".yiiActiveForm");
e(this).removeData("yiiActiveForm")})},data:function(){return this.data("yiiActiveForm")},validate:function(a){a&&(e(this).data("yiiActiveForm").submitting=!0);var b=e(this),c=b.data("yiiActiveForm"),d=!1,f={},g=A(),k=c.submitting&&!a;if(c.submitting&&(a=e.Event("beforeValidate"),b.trigger(a,[f,g]),!1===a.result)){c.submitting=!1;p(b);return}e.each(c.attributes,function(){this.$form=b;if(!e(this.input).is(":disabled")&&(this.cancelled=!1,c.submitting||2===this.status||3===this.status)){var a=f[this.id];
void 0===a&&(a=[],f[this.id]=a);var k=e.Event("beforeValidateAttribute");b.trigger(k,[this,a,g]);!1!==k.result?(this.validate&&this.validate(this,m(b,this),a,g,b),this.enableAjaxValidation&&(d=!0)):this.cancelled=!0}});e.when.apply(this,g).always(function(){for(var a in f)0===f[a].length&&delete f[a];if(d&&(e.isEmptyObject(f)||c.submitting)){a=c.submitObject;var g="&"+c.settings.ajaxParam+"="+b.attr("id");a&&a.length&&a.attr("name")&&(g+="&"+a.attr("name")+"="+a.attr("value"));e.ajax({url:c.settings.validationUrl,
type:b.attr("method"),data:b.serialize()+g,dataType:c.settings.ajaxDataType,complete:function(a,c){b.trigger("ajaxComplete",[a,c])},beforeSend:function(a,c){b.trigger("ajaxBeforeSend",[a,c])},success:function(a){null!==a&&"object"===typeof a?(e.each(c.attributes,function(){this.enableAjaxValidation&&!this.cancelled||delete a[this.id]}),t(b,e.extend(f,a),k)):t(b,f,k)},error:function(){c.submitting=!1;p(b)}})}else c.submitting?setTimeout(function(){t(b,f,k)},200):t(b,f,k)})},submitForm:function(){var a=
e(this),b=a.data("yiiActiveForm");if(b.validated){b.submitting=!1;var c=e.Event("beforeSubmit");a.trigger(c);if(!1===c.result)return b.validated=!1,p(a),!1;b=a.data("yiiActiveForm").submitObject||a.find(":submit:first");b.length&&"submit"==b.attr("type")&&b.attr("name")&&(c=e('input[type="hidden"][name="'+b.attr("name")+'"]',a),c.length?c.attr("value",b.attr("value")):e("<input>").attr({type:"hidden",name:b.attr("name"),value:b.attr("value")}).appendTo(a));return!0}n=e.Deferred();a.data("yiiSubmitFinalizePromise",
n.promise());void 0!==b.settings.timer&&clearTimeout(b.settings.timer);b.submitting=!0;h.validate.call(a);return!1},resetForm:function(){var a=e(this),b=a.data("yiiActiveForm");setTimeout(function(){e.each(b.attributes,function(){this.value=m(a,this);this.status=0;var c=a.find(this.container);c.removeClass(b.settings.validatingCssClass+" "+b.settings.errorCssClass+" "+b.settings.successCssClass);c.find(this.error).html("")});a.find(b.settings.errorSummary).hide().find("ul").html("")},1)},updateMessages:function(a,
b){var c=e(this),d=c.data("yiiActiveForm");e.each(d.attributes,function(){u(c,this,a)});b&&x(c,a)},updateAttribute:function(a,b){var c=h.find.call(this,a);if(void 0!=c){var d={};d[a]=b;u(e(this),c,d)}}},w=function(a,b){var c=q(a,b);if(b.validateOnChange)c.on("change.yiiActiveForm",function(){r(a,b,!1)});if(b.validateOnBlur)c.on("blur.yiiActiveForm",function(){0!=b.status&&1!=b.status||r(a,b,!0)});if(b.validateOnType)c.on("keyup.yiiActiveForm",function(c){-1===e.inArray(c.which,[16,17,18,37,38,39,
40])&&b.value!==m(a,b)&&r(a,b,!1,b.validationDelay)})},r=function(a,b,c,d){var f=a.data("yiiActiveForm");c&&(b.status=2);e.each(f.attributes,function(){this.value!==m(a,this)&&(this.status=2,c=!0)});c&&(void 0!==f.settings.timer&&clearTimeout(f.settings.timer),f.settings.timer=setTimeout(function(){f.submitting||a.is(":hidden")||(e.each(f.attributes,function(){2===this.status&&(this.status=3,a.find(this.container).addClass(f.settings.validatingCssClass))}),h.validate.call(a))},d?d:200))},A=function(){var a=
[];a.add=function(a){this.push(new e.Deferred(a))};return a},l=["action","target","method","enctype"],z=function(a){for(var b={},c=0;c<l.length;c++)b[l[c]]=a.attr(l[c]);return b},B=function(a,b){for(var c=0;c<l.length;c++){var d=b.attr("form"+l[c]);d&&a.attr(l[c],d)}},C=function(a){for(var b=a.data("yiiActiveForm"),c=0;c<l.length;c++)a.attr(l[c],b.options[l[c]]||null)},t=function(a,b,c){var d=a.data("yiiActiveForm");if(void 0===d)return!1;if(c){var f=[];e.each(d.attributes,function(){e(this.input).is(":disabled")||
this.cancelled||!u(a,this,b)||f.push(this)});a.trigger("afterValidate",[b,f]);x(a,b);if(f.length){if(d.settings.scrollToError){c=a.find(e.map(f,function(a){return a.input}).join(",")).first().closest(":visible").offset().top-d.settings.scrollToErrorOffset;0>c?c=0:c>e(document).height()&&(c=e(document).height());var g=e(window).scrollTop();(c<g||c>g+e(window).height())&&e(window).scrollTop(c)}d.submitting=!1}else d.validated=!0,d.submitObject&&B(a,d.submitObject),a.submit(),d.submitObject&&C(a)}else e.each(d.attributes,
function(){this.cancelled||2!==this.status&&3!==this.status||u(a,this,b)});p(a)},u=function(a,b,c){var d=a.data("yiiActiveForm"),f=q(a,b),g=!1;e.isArray(c[b.id])||(c[b.id]=[]);a.trigger("afterValidateAttribute",[b,c[b.id]]);b.status=1;if(f.length){g=0<c[b.id].length;f=a.find(b.container);var k=f.find(b.error),h=g;b.updateAriaInvalid&&a.find(b.input).attr("aria-invalid",h?"true":"false");g?(b.encodeError?k.text(c[b.id][0]):k.html(c[b.id][0]),f.removeClass(d.settings.validatingCssClass+" "+d.settings.successCssClass).addClass(d.settings.errorCssClass)):
(k.empty(),f.removeClass(d.settings.validatingCssClass+" "+d.settings.errorCssClass+" ").addClass(d.settings.successCssClass));b.value=m(a,b)}return g},x=function(a,b){var c=a.data("yiiActiveForm"),d=a.find(c.settings.errorSummary),f=d.find("ul").empty();d.length&&b&&(e.each(c.attributes,function(){if(e.isArray(b[this.id])&&b[this.id].length){var a=e("<li/>");c.settings.encodeErrorSummary?a.text(b[this.id][0]):a.html(b[this.id][0]);f.append(a)}}),d.toggle(0<f.find("li").length))},m=function(a,b){var c=
q(a,b),d=c.attr("type");return"checkbox"===d||"radio"===d?(d=c.filter(":checked"),d.length||(d=a.find('input[type=hidden][name="'+c.attr("name")+'"]')),d.val()):c.val()},q=function(a,b){var c=a.find(b.input);return c.length&&"div"===c[0].tagName.toLowerCase()?c.find("input"):c}})(window.jQuery);